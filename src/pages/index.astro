---
import BaseLayout from "../layouts/BaseLayout.astro";
import { db } from "../lib/firebase.js";
import { collection, getDocs, query, orderBy } from "firebase/firestore";

// SEOæƒ…å ±
const title = "ã‚·ã‚¬ã‚´ãƒ« | æ»‹è³€ã®ãƒªã‚¢ãƒ«ãªã‚´ãƒ«ãƒ•ç·´ç¿’å ´ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ãƒˆ";
const description =
    "ã‚·ã‚¬ã‚´ãƒ«ã¯ã€æ»‹è³€çœŒå†…ã®ã‚´ãƒ«ãƒ•ç·´ç¿’å ´ã®ãƒªã‚¢ãƒ«ãªå£ã‚³ãƒŸãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ãƒˆã€‚æ¸¬å®šå™¨ã®æœ‰ç„¡ã€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãƒ»ãƒãƒ³ã‚«ãƒ¼ç·´ç¿’å ´ã®ä½µè¨­ãªã©ã€ã‚ãªãŸã®ç›®çš„ã«åˆã£ãŸç·´ç¿’å ´æ¢ã—ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚";

// ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
let practiceRanges = [];
let fetchError = false;

try {
    const rangesCollection = collection(
        db,
        "artifacts",
        import.meta.env.PUBLIC_VITE_APP_ID,
        "public",
        "data",
        "practice_ranges",
    );
    // åˆæœŸè¡¨ç¤ºã¯ãŠã™ã™ã‚é †ï¼ˆã“ã®ä¾‹ã§ã¯ã²ã¨ã¾ãšè©•ä¾¡é †ã«ã—ã¦ãŠãï¼‰
    const q = query(rangesCollection, orderBy("avgRating", "desc"));
    const querySnapshot = await getDocs(q);
    practiceRanges = querySnapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
    }));
} catch (error) {
    console.error("Firebase data fetching failed:", error);
    fetchError = true;
}
---

<BaseLayout title={title} description={description}>
    <main class="container mx-auto p-4 md:p-6">
        <div class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold mb-2">
                æ»‹è³€ã®ã‚´ãƒ«ãƒ•ç·´ç¿’å ´ã‚’æ¢ã™
            </h1>
            <p class="text-slate-500">
                ã‚ãªãŸã®ç›®çš„ã«åˆã£ãŸ<br />æœ€é«˜ã®ç·´ç¿’ç’°å¢ƒã‚’è¦‹ã¤ã‘ã‚ˆã†ã€‚
            </p>
            <p class="text-amber-600 font-semibold mt-2">
                by é–¢ï¼ åˆå¿ƒè€…å‘ã‘ã‚´ãƒ«ãƒ•æ–½è¨­ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼
            </p>
        </div>
        <div class="mb-6 flex justify-center">
            <div class="inline-flex rounded-md shadow-sm" role="group">
                <a
                    href="/"
                    class="px-4 py-2 text-sm font-medium text-white bg-green-600 border border-green-600 rounded-l-lg hover:bg-green-700"
                    aria-current="page"
                >
                    ãƒªã‚¹ãƒˆè¡¨ç¤º
                </a>
                <a
                    href="/map"
                    class="px-4 py-2 text-sm font-medium text-green-600 bg-white border border-green-600 rounded-r-md hover:bg-green-50"
                >
                    ãƒãƒƒãƒ—ã§æ¢ã™
                </a>
            </div>
        </div>

        <div
            id="filters"
            class="bg-white p-2 rounded-lg shadow-sm mb-6 sticky top-[68px] z-10 bg-opacity-95 backdrop-blur-sm"
        >
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                <input
                    type="text"
                    id="search-keyword"
                    placeholder="ç·´ç¿’å ´åã§æ¤œç´¢..."
                    class="w-full p-2 border border-slate-300 rounded-md"
                />
                <select
                    id="filter-area"
                    class="w-full p-2 border border-slate-300 rounded-md"
                >
                    <option value="">ã™ã¹ã¦ã®ã‚¨ãƒªã‚¢</option>
                    <option value="å¤§æ´¥">å¤§æ´¥ã‚¨ãƒªã‚¢</option>
                    <option value="è‰æ´¥ãƒ»æ —æ±ãƒ»å®ˆå±±ãƒ»é‡æ´²"
                        >è‰æ´¥ãƒ»æ —æ±ãƒ»å®ˆå±±ãƒ»é‡æ´²ã‚¨ãƒªã‚¢</option
                    >
                    <option value="ç”²è³€ãƒ»æ¹–å—">ç”²è³€ãƒ»æ¹–å—ã‚¨ãƒªã‚¢</option>
                    <option value="è¿‘æ±Ÿå…«å¹¡ãƒ»æ±è¿‘æ±Ÿ"
                        >è¿‘æ±Ÿå…«å¹¡ãƒ»æ±è¿‘æ±Ÿã‚¨ãƒªã‚¢</option
                    >
                    <option value="æ¹–åŒ—">æ¹–åŒ—ã‚¨ãƒªã‚¢</option>
                    <option value="æ¹–è¥¿">æ¹–è¥¿ã‚¨ãƒªã‚¢</option>
                </select>
                <select
                    id="sort-order"
                    class="w-full p-2 border border-slate-300 rounded-md"
                >
                    <option value="default">ãŠã™ã™ã‚é †</option>
                    <option value="rating_desc">è©•ä¾¡ãŒé«˜ã„é †</option>
                    <option value="reviews_desc">ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¤šã„é †</option>
                </select>
            </div>
            <div class="mt-2 pt-2 border-t border-slate-200">
                <label class="text-xs font-medium text-slate-600"
                    >è¨­å‚™ã§çµã‚Šè¾¼ã‚€:</label
                >
                <div
                    class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 items-center mt-1"
                    role="group"
                >
                    <label class="flex items-center space-x-2"
                        ><input
                            type="checkbox"
                            name="feature"
                            value="hasTracer"
                        /><span>ğŸ“¡ æ¸¬å®šå™¨</span></label
                    >
                    <label class="flex items-center space-x-2"
                        ><input
                            type="checkbox"
                            name="feature"
                            value="hasApproach"
                        /><span>â›³ï¸ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ</span></label
                    >
                    <label class="flex items-center space-x-2"
                        ><input
                            type="checkbox"
                            name="feature"
                            value="hasBunker"
                        /><span>ğŸ•³ï¸ ãƒãƒ³ã‚«ãƒ¼</span></label
                    >
                    <label class="flex items-center space-x-2"
                        ><input
                            type="checkbox"
                            name="feature"
                            value="hasPutter"
                        /><span>ğŸŒï¸ ãƒ‘ã‚¿ãƒ¼</span></label
                    >
                    <label class="flex items-center space-x-2"
                        ><input
                            type="checkbox"
                            name="feature"
                            value="hasUchihodai"
                        /><span>ğŸ’° æ‰“æ”¾é¡Œ</span></label
                    >
                </div>
            </div>
        </div>
        <div
            id="cta-magazine"
            class="bg-gradient-to-r from-green-600 to-emerald-700 text-white p-6 rounded-lg shadow-lg mb-8 text-center"
            role="region"
            aria-labelledby="cta-magazine-title"
        >
            <h3 id="cta-magazine-title" class="text-2xl font-bold mb-2">
                ç„¡é§„ã‚¼ãƒ­ã§100åˆ‡ã‚Šï¼ã‚´ãƒ«ãƒ•ç·´ç¿’è¨­è¨ˆå›³
            </h3>
            <p class="mb-4">
                ã€Œç·´ç¿’ã—ã¦ã‚‹ã®ã«ä¸Šæ‰‹ããªã‚‰ãªã„â€¦ã€ã‚’è§£æ±ºã—ã€<br />
                å¹´é–“æ•°ä¸‡å††ã®ã‚³ã‚¹ãƒˆã‚’ã‚«ãƒƒãƒˆã™ã‚‹å…·ä½“çš„ãªè¡Œå‹•ãƒãƒƒãƒ—ã‚’é™å®šå…¬é–‹ä¸­ï¼
            </p>
            <a
                href="https://note.com/seki_golf_39/m/m57fd539cb6b1"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-block bg-white text-green-700 font-bold py-2 px-6 rounded-full hover:bg-gray-100 transition"
                >è³¼å…¥è€…é™å®šãƒ„ãƒ¼ãƒ«ä»˜ããƒã‚¬ã‚¸ãƒ³ã‚’è¦‹ã‚‹</a
            >
        </div>
        {
            fetchError ? (
                <div class="text-center py-16 bg-red-50 text-red-700 rounded-lg">
                    <p class="text-lg font-semibold">
                        ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚
                    </p>
                    <p class="text-slate-600 mt-2">
                        æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
                    </p>
                </div>
            ) : (
                <div
                    id="range-list"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
                >
                    {practiceRanges.map((range) => {
                        const badges = [];
                        if (range.isIndoor) badges.push("ã‚¤ãƒ³ãƒ‰ã‚¢");
                        if (range.is_beginner_friendly)
                            badges.push("åˆå¿ƒè€…ã«å„ªã—ã„");
                        if (range.hasTracer) badges.push("å¼¾é“æ¸¬å®šå™¨ã‚ã‚Š");
                        if (range.tags && range.tags.includes("GPä½µè¨­"))
                            badges.push("GPä½µè¨­");
                        if (range.hasUchihodai) badges.push("æ‰“ã¡æ”¾é¡Œã‚ã‚Š");

                        return (
                            <a
                                href={`/ranges/${range.id}`}
                                class="range-card flex flex-col bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300"
                                data-name={range.name.toLowerCase()}
                                data-area={range.area}
                                data-tracer={range.hasTracer}
                                data-approach={range.hasApproach}
                                data-bunker={range.hasBunker}
                                data-putter={range.hasPutter}
                                data-uchihodai={range.hasUchihodai}
                                data-rating={range.avgRating || 0}
                                data-reviews={range.reviewCount || 0}
                            >
                                <img
                                    src={range.imageUrl}
                                    alt={`${range.name}ã®å¤–è¦³`}
                                    class="w-full h-40 object-cover"
                                />
                                <div class="p-4 flex-grow flex flex-col">
                                    <p class="text-sm text-green-600 font-semibold">
                                        {range.area}ã‚¨ãƒªã‚¢
                                    </p>
                                    <h2 class="text-xl font-bold mt-1 text-slate-800">
                                        {range.name}
                                    </h2>

                                    {badges.length > 0 && (
                                        <div class="mt-2 flex flex-wrap gap-1">
                                            {badges.slice(0, 2).map((badge) => (
                                                <span class="text-xs bg-emerald-100 text-emerald-800 font-semibold px-2 py-1 rounded-full">
                                                    {badge}
                                                </span>
                                            ))}
                                        </div>
                                    )}

                                    <div class="mt-auto pt-2 flex items-center text-sm text-slate-500">
                                        <span class="text-amber-500">
                                            {"â˜…".repeat(
                                                Math.round(
                                                    range.avgRating || 0,
                                                ),
                                            ) +
                                                "â˜†".repeat(
                                                    5 -
                                                        Math.round(
                                                            range.avgRating ||
                                                                0,
                                                        ),
                                                )}
                                        </span>
                                        <span class="ml-2">
                                            ({range.reviewCount || 0}ä»¶)
                                        </span>
                                    </div>
                                </div>
                            </a>
                        );
                    })}
                </div>
            )
        }
    </main>
</BaseLayout>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- DOMè¦ç´ ã®å–å¾— ---
        const searchInput = document.getElementById("search-keyword");
        const areaFilter = document.getElementById("filter-area");
        const sortOrder = document.getElementById("sort-order");
        const featureCheckboxes = document.querySelectorAll(
            'input[name="feature"]',
        );
        const rangeList = document.getElementById("range-list");
        // NodeListã‚’Arrayã«å¤‰æ›ã—ã¦ãŠã
        const rangeCards = Array.from(document.querySelectorAll(".range-card"));

        const featureMap = {
            hasTracer: "tracer",
            hasApproach: "approach",
            hasBunker: "bunker",
            hasPutter: "putter",
            hasUchihodai: "uchihodai",
        };
        
        // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã‚½ãƒ¼ãƒˆã‚’ã¾ã¨ã‚ã¦å®Ÿè¡Œã™ã‚‹é–¢æ•° ---
        function applySortAndFilters() {
            // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç† ---
            const keyword = searchInput.value.toLowerCase();
            const area = areaFilter.value;
            const checkedFeatures = {};
            featureCheckboxes.forEach((checkbox) => {
                if (checkbox.checked) {
                    const dataKey = featureMap[checkbox.value];
                    if (dataKey) {
                        checkedFeatures[dataKey] = true;
                    }
                }
            });

            // è¡¨ç¤ºã™ã¹ãã‚«ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
            const visibleCards = rangeCards.filter(card => {
                const nameMatch = card.dataset.name.includes(keyword);
                const areaMatch = area === "" || card.dataset.area === area;
                
                let featuresMatch = true;
                for (const feature in checkedFeatures) {
                    if (card.dataset[feature] !== "true") {
                        featuresMatch = false;
                        break;
                    }
                }
                return nameMatch && areaMatch && featuresMatch;
            });

            // --- ã‚½ãƒ¼ãƒˆå‡¦ç† ---
            const sortBy = sortOrder.value;
            if (sortBy !== 'default') {
                visibleCards.sort((a, b) => {
                    if (sortBy === 'rating_desc') {
                        return parseFloat(b.dataset.rating) - parseFloat(a.dataset.rating);
                    }
                    if (sortBy === 'reviews_desc') {
                        return parseInt(b.dataset.reviews) - parseInt(a.dataset.reviews);
                    }
                    return 0;
                });
            }
            // 'default'ã®å ´åˆã¯ã‚½ãƒ¼ãƒˆã›ãšã€å…ƒã®HTMLã®é †åºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿ï¼‰ã‚’ç¶­æŒ

            // --- DOMã®æ›´æ–° ---
            // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¸€æ—¦éè¡¨ç¤ºã«
            rangeCards.forEach(card => card.style.display = 'none');
            // è¡¨ç¤ºã™ã¹ãã‚«ãƒ¼ãƒ‰ã‚’é †ç•ªé€šã‚Šã«è¡¨ç¤º
            visibleCards.forEach(card => {
                card.style.display = 'flex';
                // DOMä¸Šã§ã‚«ãƒ¼ãƒ‰ã‚’æ­£ã—ã„é †åºã«ã™ã‚‹ãŸã‚ã€rangeListã«å†åº¦è¿½åŠ 
                rangeList.appendChild(card);
            });
        }
        
        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---
        searchInput.addEventListener("input", applySortAndFilters);
        areaFilter.addEventListener("change", applySortAndFilters);
        sortOrder.addEventListener("change", applySortAndFilters);
        featureCheckboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", applySortAndFilters);
        });

        // åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚‚ä¸€åº¦å®Ÿè¡Œ
        applySortAndFilters();
    });
</script>