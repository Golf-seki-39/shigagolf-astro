---
import ReviewSection from '../../components/ReviewSection.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { db } from '../../lib/firebase.js';
import { collection, getDocs, query, orderBy } from 'firebase/firestore';

export async function getStaticPaths() {
  const rangesCollection = collection(db, 'artifacts', import.meta.env.PUBLIC_VITE_APP_ID, 'public', 'data', 'practice_ranges');
  const querySnapshot = await getDocs(rangesCollection);
  const ranges = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  return ranges.map(range => ({
    params: { rangeId: range.id },
    props: { range },
  }));
}

const { range } = Astro.props;
const title = `${range.name}ã®å£ã‚³ãƒŸãƒ»è©•åˆ¤ | ã‚·ã‚¬ã‚´ãƒ«`;
const description = `${range.name}ï¼ˆ${range.area}ã‚¨ãƒªã‚¢ï¼‰ã®å£ã‚³ãƒŸãƒ»è©•åˆ¤ã‚’ãƒã‚§ãƒƒã‚¯ã€‚æ–™é‡‘ã€è¨­å‚™ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã©ã€${range.name}ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ãŒæº€è¼‰ã§ã™ã€‚`;

// --- ç‰¹å¾´ãƒãƒƒã‚¸ã‚’ã€æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ ---
const badges = [];
if (range.isIndoor) badges.push("ã‚¤ãƒ³ãƒ‰ã‚¢");
if (range.is_beginner_friendly) badges.push("åˆå¿ƒè€…ã«å„ªã—ã„");
if (range.hasTracer && range.tracer_brand === 'ãƒˆãƒƒãƒ—ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼') badges.push("å…¨æ‰“å¸­ãƒˆãƒƒãƒ—ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼");
else if (range.hasTracer) badges.push("å¼¾é“æ¸¬å®šå™¨ã‚ã‚Š");
if (range.tags && range.tags.includes("GPä½µè¨­")) badges.push("GPä½µè¨­");

// --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾— ---
const reviewsCollection = collection(db, 'artifacts', import.meta.env.PUBLIC_VITE_APP_ID, 'public', 'data', 'practice_ranges', range.id, 'reviews');
const q = query(reviewsCollection, orderBy("createdAt", "desc"));
const reviewsSnapshot = await getDocs(q);
const reviews = reviewsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

// --- ã€Œå…¬å¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã‚’ä¸€ç•ªä¸Šã«ã™ã‚‹ãŸã‚ã®ä¸¦ã¹æ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ ---
const adminReviews = reviews.filter(review => review.author === 'é–¢ï¼ ã‚·ã‚¬ã‚´ãƒ«ç®¡ç†äºº');
const userReviews = reviews.filter(review => review.author !== 'é–¢ï¼ ã‚·ã‚¬ã‚´ãƒ«ç®¡ç†äºº');
const sortedReviews = [...adminReviews, ...userReviews];
---

<BaseLayout title={title} description={description}>
  <main class="container mx-auto p-4 md:p-6">
    <div class="mb-4">
      <a href="/" class="text-green-700 font-semibold hover:underline">â€¹ ç·´ç¿’å ´ä¸€è¦§ã«æˆ»ã‚‹</a>
    </div>

    <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
      <header>
        <img src={range.imageUrl} alt={`${range.name}ã®å¤–è¦³`} class="w-full h-64 object-cover rounded-lg mb-6" loading="lazy">
        <div>
          <p class="text-lg text-green-600 font-semibold">{range.area}ã‚¨ãƒªã‚¢</p>
          <h1 class="text-4xl font-bold mt-1">{range.name}</h1>
          
          {badges.length > 0 && (
            <div class="mt-4 flex flex-wrap gap-2">
              {badges.map(badge => (
                <span class="text-sm bg-blue-100 text-blue-800 font-semibold px-3 py-1 rounded-full">
                  {badge}
                </span>
              ))}
            </div>
          )}
        </div>
        <div class="my-6 grid grid-cols-2 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden text-center">
          <div class="bg-white p-4">
            <p class="text-sm text-slate-500">ãƒ¤ãƒ¼ãƒ‰æ•°</p>
            <p class="text-2xl font-bold">
              {range.isIndoor ? <span class="whitespace-nowrap">ï¼ˆã‚¤ãƒ³ãƒ‰ã‚¢ï¼‰</span> : (range.yardage ? `${range.yardage}yd` : '-')}
            </p>
          </div>
          <div class="bg-white p-4">
            <p class="text-sm text-slate-500">æ‰“å¸­æ•°</p>
            <p class="text-2xl font-bold">{range.bays ? `${range.bays}æ‰“å¸­` : '-'}</p>
          </div>
        </div>
      </header>

      <div class="mt-8 pt-6 border-t border-slate-200 space-y-8">
        <section>
          <h2 class="text-2xl font-bold">è¨­å‚™æƒ…å ±</h2>
          <ul class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-4 text-slate-600">
            <li>ğŸ“¡ å¼¾é“æ¸¬å®šå™¨: {range.hasTracer ? `ã‚ã‚Š (${range.tracer_brand})` : 'ãªã—'}</li>
            <li>â›³ï¸ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: {range.hasApproach ? 'ã‚ã‚Š' : 'ãªã—'}</li>
            <li>ğŸ•³ï¸ ãƒãƒ³ã‚«ãƒ¼: {range.hasBunker ? 'ã‚ã‚Š' : 'ãªã—'}</li>
            <li>ğŸŒï¸ ãƒ‘ã‚¿ãƒ¼: {range.hasPutter ? 'ã‚ã‚Š' : 'ãªã—'}</li>
            <li>ğŸ’° æ‰“ã¡æ”¾é¡Œ: {range.hasUchihodai ? 'ã‚ã‚Š' : 'ãªã—'}</li>
          </ul>
        </section>
        <section>
          <h2 class="text-2xl font-bold">æ–™é‡‘æƒ…å ±</h2>
          <div class="mt-2 overflow-x-auto border border-slate-200 rounded-lg">
            <table class="min-w-full text-sm">
              <tbody class="text-slate-600">
                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 w-1/3 whitespace-nowrap">çƒå˜ä¾¡ï¼ˆå¹³æ—¥ï¼‰</th><td class="py-3 px-4" set:html={range.price_ball_weekday_str ? range.price_ball_weekday_str.replace(/\//g, '<br>').replace(/\(/g, '<br>(') : 'æƒ…å ±ãªã—'} /></tr>
                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">çƒå˜ä¾¡ï¼ˆåœŸæ—¥ç¥ï¼‰</th><td class="py-3 px-4" set:html={range.price_ball_weekend_str ? range.price_ball_weekend_str.replace(/\//g, '<br>').replace(/\(/g, '<br>(') : 'æƒ…å ±ãªã—'} /></tr>
                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">æ‰“ã¡æ”¾é¡Œï¼ˆå¹³æ—¥ï¼‰</th><td class="py-3 px-4" set:html={range.hasUchihodai ? (range.price_uchihodai_weekday_str ? range.price_uchihodai_weekday_str.replace(/\//g, '<br>').replace(/\(/g, '<br>(') : 'æƒ…å ±ãªã—') : 'æ‰“æ”¾é¡Œãªã—'} /></tr>
                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">æ‰“ã¡æ”¾é¡Œï¼ˆåœŸæ—¥ç¥ï¼‰</th><td class="py-3 px-4" set:html={range.hasUchihodai ? (range.price_uchihodai_weekend_str ? range.price_uchihodai_weekend_str.replace(/\//g, '<br>').replace(/\(/g, '<br>(') : 'æƒ…å ±ãªã—') : 'æ‰“æ”¾é¡Œãªã—'} /></tr>
                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç·´ç¿’å ´</th><td class="py-3 px-4">{range.approach_fee_info || 'æƒ…å ±ãªã—'}</td></tr>
                <tr><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">ãƒãƒ³ã‚«ãƒ¼ç·´ç¿’å ´</th><td class="py-3 px-4">{range.bunker_fee_info || 'æƒ…å ±ãªã—'}</td></tr>
              </tbody>
            </table>
          </div>
          <ul class="mt-4 space-y-2 text-slate-600 text-sm">
            <li><strong>æ”¯æ‰•ã„æ–¹æ³•:</strong> {range.payment_methods || 'æƒ…å ±ãªã—'}</li>
            <li><strong>æœ€ä½æ–™é‡‘ã®ç›®å®‰:</strong> {range.initial_cost || 'æƒ…å ±ãªã—'}</li>
          </ul>
        </section>
        <section>
          <h2 class="text-2xl font-bold">åŸºæœ¬æƒ…å ±</h2>
          <ul class="mt-2 space-y-2 text-slate-600">
            <li><strong>å–¶æ¥­æ™‚é–“:</strong> {range.business_hours || 'æƒ…å ±ãªã—'}</li>
            <li><strong>ä½æ‰€:</strong> <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(range.address || '')}`} target="_blank" rel="noopener noreferrer" class="text-green-700 hover:underline">{range.address || 'æƒ…å ±ãªã—'}</a></li>
            <li><strong>é›»è©±ç•ªå·:</strong> <a href={`tel:${range.phone}`} class="text-green-700 hover:underline">{range.phone || 'æƒ…å ±ãªã—'}</a></li>
            <li><strong>ã‚¢ã‚¯ã‚»ã‚¹:</strong> {range.access || 'æƒ…å ±ãªã—'}</li>
            <li><strong>é§è»Šå ´:</strong> {range.parking_info || 'æƒ…å ±ãªã—'}</li>
            <li><strong>ãƒ¬ãƒ³ã‚¿ãƒ«ã‚¯ãƒ©ãƒ–:</strong> {range.rental_club_info || 'æƒ…å ±ãªã—'}</li>
            <li><strong>å·¦åˆ©ãæ‰“å¸­:</strong> {range.lefty_bays_info || 'æƒ…å ±ãªã—'}</li>
            <li class="pt-2 mt-2 border-t border-slate-200">
                <strong>é–¢é€£ãƒªãƒ³ã‚¯:</strong>
                <div class="flex flex-col sm:flex-row sm:space-x-4 mt-1">
                    <a href={range.website} target="_blank" rel="noopener noreferrer" class="text-green-700 hover:underline">å…¬å¼ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹</a>
                    {range.noteUrl && <a href={range.noteUrl} target="_blank" rel="noopener noreferrer" class="text-green-700 hover:underline">ç§ã®noteè¨˜äº‹ã‚’èª­ã‚€</a>}
                    {range.medleyUrl && <a href={range.medleyUrl} target="_blank" rel="noopener noreferrer" class="text-green-700 hover:underline">ã‚´ãƒ«ãƒ•ãƒ¡ãƒ‰ãƒ¬ãƒ¼è¨˜äº‹ã‚’èª­ã‚€</a>}
                </div>
            </li>
          </ul>
        </section>
      </div>
      
      <div class="my-8 text-center">
        <button id="show-review-form-btn" class="bg-amber-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-amber-600 transition text-lg">
          ã“ã®ç·´ç¿’å ´ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã
        </button>
      </div>

      <section class="mt-8 pt-6 border-t border-slate-200">
        <h2 class="text-2xl font-bold mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <div class="space-y-6">
          {sortedReviews.length > 0 ? (
            sortedReviews.map(review => {
              const stars = 'â˜…'.repeat(review.rating) + 'â˜†'.repeat(5 - review.rating);
              const date = review.createdAt?.toDate ? review.createdAt.toDate().toLocaleDateString('ja-JP') : 'æ—¥ä»˜ä¸æ˜';
              const isAdminReview = review.author === 'é–¢ï¼ ã‚·ã‚¬ã‚´ãƒ«ç®¡ç†äºº';
              return (
                <article class="border-b border-slate-200 pb-6">
                  <div class="flex items-center gap-x-4">
                    <div class="text-amber-500 text-xl" title={`${review.rating}ã¤æ˜Ÿ`}>{stars}</div>
                    {isAdminReview && (<span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">å…¬å¼ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>)}
                  </div>
                  <h3 class="text-lg font-bold mt-2">{review.title}</h3>
                  {isAdminReview && review.scores && (
                    <div class="my-4 max-w-sm mx-auto">
                      <canvas class="radar-chart-canvas" data-scores={JSON.stringify(review.scores)}></canvas>
                    </div>
                  )}
                  <p class="text-slate-600 my-4 whitespace-pre-wrap">{review.body}</p>
                  {review.imageUrls && review.imageUrls.length > 0 && (
                    <div class="mt-4 flex flex-wrap gap-3">
                      {review.imageUrls.map(url => (
                        <a href={url} target="_blank" rel="noopener noreferrer" class="block">
                          <img src={url} alt="ãƒ¬ãƒ“ãƒ¥ãƒ¼å†™çœŸ" class="w-28 h-28 sm:w-32 sm:h-32 md:w-40 md:h-40 object-cover rounded-md hover:opacity-80 transition" loading="lazy" />
                        </a>
                      ))}
                    </div>
                  )}
                  <p class="text-sm text-slate-400 text-right mt-4">æŠ•ç¨¿è€…: {review.author} / æŠ•ç¨¿æ—¥: {date}</p>
                </article>
              )
            })
          ) : (
            <p class="text-slate-500 text-center py-4">ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¾ã›ã‚“ã‹ï¼Ÿ</p>
          )}
        </div>
      </section>

      <div id="review-form-wrapper" class="hidden">
        <ReviewSection range={range} />
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const showButton = document.getElementById('show-review-form-btn');
    const formWrapper = document.getElementById('review-form-wrapper');
    if (!showButton || !formWrapper) { return; }
    showButton.addEventListener('click', () => {
      formWrapper.classList.remove('hidden');
      showButton.style.display = 'none';
      formWrapper.scrollIntoView({ behavior: 'smooth' });
    });
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const chartCanvases = document.querySelectorAll('.radar-chart-canvas');
    chartCanvases.forEach(canvas => {
      const scoresData = JSON.parse(canvas.dataset.scores);
      const labels = Object.keys(scoresData);
      const data = Object.values(scoresData);
      new Chart(canvas, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            label: 'è©•ä¾¡ã‚¹ã‚³ã‚¢',
            data: data,
            fill: true,
            backgroundColor: 'rgba(34, 197, 94, 0.2)',
            borderColor: 'rgb(22, 163, 74)',
            pointBackgroundColor: 'rgb(22, 163, 74)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgb(22, 163, 74)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: { display: false },
              suggestedMin: 0,
              suggestedMax: 5,
              pointLabels: { font: { size: 10 } }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    });
  });
</script>