---
// Geminiæœ€çµ‚ä¿®æ­£ç‰ˆ: 2024/09/09
// SSGï¼ˆé™çš„ï¼‰ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã¨æç”»ã®ã¿ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§è¡Œã„ã¾ã™ã€‚
// è‡´å‘½çš„ã ã£ãŸ SyntaxError (import.meta) ã¨ 403 (Map URL) ã®ä¸¡æ–¹ã‚’ä¿®æ­£æ¸ˆã¿ã§ã™ã€‚

import BaseLayout from "../../layouts/BaseLayout.astro";
import ReviewSection from "../../components/ReviewSection.astro";
import { db } from "../../lib/firebase.js"; // getStaticPaths ã§ä½¿ç”¨
import { collection, getDocs } from "firebase/firestore";

// 1. ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€Œé™çš„ãƒšãƒ¼ã‚¸ã€ã¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã•ã‚Œã‚‹ãŸã‚ã€getStaticPathsãŒå¿…é ˆã§ã™
export async function getStaticPaths() {
    const appId = import.meta.env.PUBLIC_FIREBASE_APP_ID;
    const publicDataPath = `artifacts/${appId}/public/data`;
    const rangesCollection = collection(db, publicDataPath, 'practice_ranges');
    const querySnapshot = await getDocs(rangesCollection);

    const paths = querySnapshot.docs.map(doc => ({
        params: { rangeId: doc.id },
        props: { range: { id: doc.id, ...doc.data() } } // rangeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’propsã¨ã—ã¦æ¸¡ã™
    }));
    return paths;
}

// 2. å€‹åˆ¥ã®ãƒšãƒ¼ã‚¸ã‚’ä½œã‚‹éš›ã«ã€ãã®ç·´ç¿’å ´ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
// (å…ƒã®ã‚³ãƒ¼ãƒ‰ã®é™çš„HTMLã§å¿…è¦ãªã™ã¹ã¦ã®å¤‰æ•°ã‚’å±•é–‹ã—ã¾ã™)
const { range } = Astro.props;
const { id, name, address, phone, businessHours, website, scores, area, city, postalCode, reviewCount, avgRating, imageUrl, isIndoor, is_beginner_friendly, hasTracer, tracer_brand, tags, galleryImages, yardage, bays, hasApproach, hasBunker, hasPutter, hasUchihodai, price_ball_weekday_str, price_ball_weekend_str, price_uchihodai_weekday_str, price_uchihodai_weekend_str, approach_fee_info, bunker_fee_info, payment_methods, initial_cost, access, parking_info, rental_club_info, lefty_bays_info, managerReviewUrl } = range;


// 3. å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã€ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚„èª¬æ˜æ–‡ãªã©ã‚’æº–å‚™ã™ã‚‹ (å…ƒã®ã‚³ãƒ¼ãƒ‰ä¿æŒ)
const title = `${name}ã®å£ã‚³ãƒŸãƒ»è©•åˆ¤ | ã‚·ã‚¬ã‚´ãƒ«`;
const description = `${name}ï¼ˆ${area}ã‚¨ãƒªã‚¢ï¼‰ã®å£ã‚³ãƒŸãƒ»è©•åˆ¤ã‚’ãƒã‚§ãƒƒã‚¯ã€‚æ–™é‡‘ã€è¨­å‚™ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã©ã€${name}ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ãŒæº€è¼‰ã§ã™ã€‚`;

const badges = [];
if (isIndoor) badges.push("ã‚¤ãƒ³ãƒ‰ã‚¢");
if (is_beginner_friendly) badges.push("åˆå¿ƒè€…ã«å„ªã—ã„");
if (hasTracer && tracer_brand === "ãƒˆãƒƒãƒ—ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼")
    badges.push("å…¨æ‰“å¸­ãƒˆãƒƒãƒ—ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼");
else if (hasTracer) badges.push("å¼¾é“æ¸¬å®šå™¨ã‚ã‚Š");
if (tags && tags.includes("GPä½µè¨­")) badges.push("GPä½µè¨­");

// isFeaturedãŒtrueã®ã‚‚ã®ã‚’å„ªå…ˆã—ã¦ä¸¦ã³æ›¿ãˆã‚‹ (å…ƒã®ã‚³ãƒ¼ãƒ‰ä¿æŒ)
galleryImages?.sort((a, b) => (b.isFeatured ? 1 : 0) - (a.isFeatured ? 1 : 0));

// SEOã®ãŸã‚ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿(JSON-LD)ã‚’æº–å‚™ (å…ƒã®ã‚³ãƒ¼ãƒ‰ä¿æŒ)
const ldJson = {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    name: name,
    image: imageUrl,
    telephone: phone,
    address: {
        "@type": "PostalAddress",
        streetAddress: address,
        addressLocality: city,
        addressRegion: "æ»‹è³€çœŒ",
        postalCode: postalCode,
        addressCountry: "JP",
    },
    ...(reviewCount > 0 && {
        aggregateRating: {
            "@type": "AggregateRating",
            ratingValue: avgRating,
            reviewCount: reviewCount,
        },
    }),
};

// ã‚µãƒ ãƒã‚¤ãƒ«URLã‚’ç”Ÿæˆã™ã‚‹é–¢æ•° (å…ƒã®ã‚³ãƒ¼ãƒ‰ä¿æŒ)
function getThumbnailUrl(originalUrl) {
    if (!originalUrl) return '';
    const urlParts = originalUrl.split('?');
    const path = urlParts[0];
    const extensionIndex = path.lastIndexOf('.');
    if (extensionIndex === -1) return `${path}?alt=media`;
    const basePath = path.substring(0, extensionIndex);
    const extension = path.substring(extensionIndex);
    const thumbnailPath = `${basePath}_400x400${extension}`;
    return `${thumbnailPath}?alt=media`;
}

// å…ƒã®URLã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã ã‘ã‚’é™¤å»ã™ã‚‹é–¢æ•° (å…ƒã®ã‚³ãƒ¼ãƒ‰ä¿æŒ)
function getPublicUrl(originalUrl) {
    if (!originalUrl) return '';
    const urlParts = originalUrl.split('?');
    const path = urlParts[0];
    return `${path}?alt=media`;
}

/*
 * ã€ä¿®æ­£æ¸ˆ Aã€‘
 * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ï¼‰ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆreviewsSnapshot, sortedReviews...ï¼‰ã¯å…¨ã¦å‰Šé™¤æ¸ˆã¿ã§ã™ã€‚
 */

// â˜…â˜…â˜… SyntaxError ä¿®æ­£ â˜…â˜…â˜…
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã«æ¸¡ã™Firebaseè¨­å®šã‚’ã€ã“ã“ã§ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ï¼‰å®‰å…¨ã«æ§‹ç¯‰ã—ã¾ã™ã€‚
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¯ import.meta.env ã‚’ä¸€åˆ‡å‚ç…§ã—ãªããªã‚Šã¾ã™ã€‚
const clientFirebaseConfig = {
    apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
    authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
    projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
    storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
    appId: import.meta.env.PUBLIC_FIREBASE_APP_ID,
};
---

<BaseLayout title={title} description={description}>
    <script type="application/ld+json" set:html={JSON.stringify(ldJson)} />

    <main class="container mx-auto p-4 md:p-6">
        <div class="mb-4">
            <a href="/" class="text-green-700 font-semibold hover:underline"
                >â€¹ ç·´ç¿’å ´ä¸€è¦§ã«æˆ»ã‚‹</a
            >
        </div>

        <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
            
            {/* â˜…â˜…â˜… ã“ã“ã‹ã‚‰ä¸‹ã®é™çš„HTMLéƒ¨åˆ†ã¯ã€ã‚ãªãŸã®å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’å®Œå…¨ã«ä¿æŒã—ã¦ã„ã¾ã™ â˜…â˜…â˜… */}
            <header>
                <img
                    src={imageUrl}
                    alt={`${name}ã®å¤–è¦³`}
                    class="w-full h-64 object-cover rounded-lg mb-6"
                    loading="lazy"
                />
                <div>
                    <p class="text-lg text-green-600 font-semibold">{area}ã‚¨ãƒªã‚¢</p>
                    <h1 class="text-4xl font-bold mt-1">{name}</h1>
                    {badges.length > 0 && (
                        <div class="mt-4 flex flex-wrap gap-2">
                            {badges.map((badge) => (
                                <span class="text-sm bg-blue-100 text-blue-800 font-semibold px-3 py-1 rounded-full">{badge}</span>
                            ))}
                        </div>
                    )}
                </div>
                <div class="my-6 grid grid-cols-2 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden text-center">
                    <div class="bg-white p-4">
                        <p class="text-sm text-slate-500">ãƒ¤ãƒ¼ãƒ‰æ•°</p>
                        <p class="text-2xl font-bold">{isIndoor ? <span class="whitespace-nowrap">ï¼ˆã‚¤ãƒ³ãƒ‰ã‚¢ï¼‰</span> : yardage ? `${yardage}yd` : "-"}</p>
                    </div>
                    <div class="bg-white p-4">
                        <p class="text-sm text-slate-500">æ‰“å¸­æ•°</p>
                        <p class="text-2xl font-bold">{bays ? `${bays}æ‰“å¸­` : "-"}</p>
                    </div>
                </div>
            </header>
             
            {galleryImages && galleryImages.length > 0 && (
              <section class="mt-8 pt-6 border-t border-slate-200">
                <h2 class="text-2xl font-bold">ãƒ•ã‚©ãƒˆã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
                <div id="gallery-grid" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                  {galleryImages.map((image, index) => (
                    <div class="gallery-item hidden">
                      <a href={getPublicUrl(image.url)} target="_blank" rel="noopener noreferrer" class="block aspect-square group">
                        <img 
                          src={getThumbnailUrl(image.url)}
                          alt={`${name}ã®ã‚®ãƒ£ãƒ©ãƒªãƒ¼å†™çœŸ ${index + 1}ï¼ˆæŠ•ç¨¿è€…: ${image.author}ï¼‰ ${image.description || ''}`}
                          class="w-full h-full object-cover rounded-lg group-hover:opacity-80 transition-opacity"
                          loading="lazy"
                        />
                      </a>
                    </div>
                  ))}
                </div>
             
                {galleryImages.length > 8 && (
                  <div class="mt-6 text-center">
                    <button id="show-more-gallery-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition">ã‚‚ã£ã¨è¦‹ã‚‹</button>
                  </div>
                )}
              </section>
            )}

            <div class="mt-8 pt-6 border-t border-slate-200 space-y-8">
                <section>
                    <h2 class="text-2xl font-bold">è¨­å‚™æƒ…å ±</h2>
                    <ul class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-4 text-slate-600">
                        <li>ğŸ“¡ å¼¾é“æ¸¬å®šå™¨: {hasTracer ? `ã‚ã‚Š (${tracer_brand})` : "ãªã—"}</li>
                        <li>â›³ï¸ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: {hasApproach ? "ã‚ã‚Š" : "ãªã—"}</li>
                        <li>ğŸ•³ï¸ ãƒãƒ³ã‚«ãƒ¼: {hasBunker ? "ã‚ã‚Š" : "ãªã—"}</li>
                        <li>ğŸŒï¸ ãƒ‘ã‚¿ãƒ¼: {hasPutter ? "ã‚ã‚Š" : "ãªã—"}</li>
                        <li>ğŸ’° æ‰“ã¡æ”¾é¡Œ: {hasUchihodai ? "ã‚ã‚Š" : "ãªã—"}</li>
                    </ul>
                </section>

                <section>
                    <h2 class="text-2xl font-bold">æ–™é‡‘æƒ…å ±</h2>
                    <div class="mt-2 overflow-x-auto border border-slate-200 rounded-lg">
                        <table class="min-w-full text-sm">
                            <tbody class="text-slate-600">
                                {!isIndoor && (
                                    <>
                                        <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 w-1/3 whitespace-nowrap">çƒå˜ä¾¡ï¼ˆå¹³æ—¥ï¼‰</th><td class="py-3 px-4" set:html={price_ball_weekday_str ? price_ball_weekday_str.replace(/\//g, "<br>").replace(/\(/g, "<br>(") : "æƒ…å ±ãªã—"} /></tr>
                                        <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">çƒå˜ä¾¡ï¼ˆåœŸæ—¥ç¥ï¼‰</th><td class="py-3 px-4" set:html={price_ball_weekend_str ? price_ball_weekend_str.replace(/\//g, "<br>").replace(/\(/g, "<br>(") : "æƒ…å ±ãªã—"} /></tr>
                                    </>
                                )}
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">æ‰“ã¡æ”¾é¡Œï¼ˆå¹³æ—¥ï¼‰</th><td class="py-3 px-4" set:html={hasUchihodai ? (price_uchihodai_weekday_str ? price_uchihodai_weekday_str.replace(/\//g, "<br>").replace(/\(/g, "<br>(") : "æƒ…å ±ãªã—") : "æ‰“æ”¾é¡Œãªã—"} /></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">æ‰“ã¡æ”¾é¡Œï¼ˆåœŸæ—¥ç¥ï¼‰</th><td class="py-3 px-4" set:html={hasUchihodai ? (price_uchihodai_weekend_str ? price_uchihodai_weekend_str.replace(/\//g, "<br>").replace(/\(/g, "<br>(") : "æƒ…å ±ãªã—") : "æ‰“æ”¾é¡Œãªã—"} /></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç·´ç¿’å ´</th><td class="py-3 px-4">{approach_fee_info || "æƒ…å ±ãªã—"}</td></tr>
                                <tr><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">ãƒãƒ³ã‚«ãƒ¼ç·´ç¿’å ´</th><td class="py-3 px-4">{bunker_fee_info || "æƒ…å ±ãªã—"}</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <ul class="mt-4 space-y-2 text-slate-600 text-sm">
                        <li><strong>æ”¯æ‰•ã„æ–¹æ³•:</strong> {payment_methods || "æƒ…å ±ãªã—"}</li>
                        <li><strong>æœ€ä½æ–™é‡‘ã®ç›®å®‰:</strong> {initial_cost || "æƒ…å ±ãªã—"}</li>
                    </ul>
                </section>

                <section>
                    <h2 class="text-2xl font-bold">åŸºæœ¬æƒ…å ±</h2>
                    <div class="mt-2 overflow-x-auto border border-slate-200 rounded-lg">
                        <table class="min-w-full text-sm">
                            <tbody class="text-slate-600">
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 w-1/4 whitespace-nowrap">å–¶æ¥­æ™‚é–“</th><td class="py-3 px-4">{businessHours || "æƒ…å ±ãªã—"}</td></tr>
                                
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50">ä½æ‰€</th><td class="py-3 px-4"><a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address || '')}`} target="_blank" rel="noopener noreferrer" class="text-green-700 hover:underline">{address || "æƒ…å ±ãªã—"}</a></td></tr>
                                
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50">é›»è©±ç•ªå·</th><td class="py-3 px-4"><a href={`tel:${phone}`} class="text-green-700 hover:underline">{phone || "æƒ…å ±ãªã—"}</a></td></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50">ã‚¢ã‚¯ã‚»ã‚¹</th><td class="py-3 px-4">{access || "æƒ…å ±ãªã—"}</td></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50">é§è»Šå ´</th><td class="py-3 px-4">{parking_info || "æƒ…å ±ãªã—"}</td></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50">ãƒ¬ãƒ³ã‚¿ãƒ«ã‚¯ãƒ©ãƒ–</th><td class="py-3 px-4">{rental_club_info || "æƒ…å ±ãªã—"}</td></tr>
                                <tr><th class="py-3 px-4 text-left font-semibold bg-slate-50">å·¦åˆ©ãæ‰“å¸­</th><td class="py-3 px-4">{lefty_bays_info || "æƒ…å ±ãªã—"}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section>
                    <h2 class="text-2xl font-bold">é–¢é€£ãƒªãƒ³ã‚¯</h2>
                    <div class="mt-2 space-y-3">
                        {managerReviewUrl && (<a href={managerReviewUrl} target="_blank" rel="noopener noreferrer" class="flex items-center gap-x-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition group border"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="font-semibold text-slate-800 group-hover:underline">ã“ã®ç·´ç¿’å ´ã®ç®¡ç†äººã®ä½“é¨“è«‡ã‚’è¦‹ã‚‹</span></a>)}
                        <a href="/articles" class="flex items-center gap-x-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition group border"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3h2m0 0h2m-2 0V5m0 2v2m0 0h2"/></svg><span class="font-semibold text-slate-800 group-hover:underline">ãŠå½¹ç«‹ã¡æƒ…å ±ä¸€è¦§</span></a>
                        {website && (<a href={website} target="_blank" rel="noopener noreferrer" class="flex items-center gap-x-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition group border"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg><span class="font-semibold text-slate-800 group-hover:underline">å…¬å¼ã‚µã‚¤ãƒˆ</span></a>)}
                    </div>
                </section>
            </div>

            <div class="my-8 text-center">
                <button id="show-review-form-btn" class="bg-amber-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-amber-600 transition text-lg">ã“ã®ç·´ç¿’å ´ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã</button>
            </div>


            {/* â˜…â˜…â˜… ä¿®æ­£æ¸ˆ B-1 â˜…â˜…â˜… */}
            {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€‚ã‚µãƒ¼ãƒãƒ¼å´ã® sortedReviews.map(...) ã‚’å‰Šé™¤ã—ã€ */}
            {/* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæç”»ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®ã¿ã‚’è¨­ç½®ã—ã¾ã™ã€‚ */}
            <section class="mt-8 pt-6 border-t border-slate-200">
                <h2 class="text-2xl font-bold mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                
                <div id="reviews-list" class="space-y-6">
                    <div id="loading-reviews" class="text-center py-8">
                        <p class="text-slate-500">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                    </div>
                    {/* ã“ã“ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã£ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ */}
                </div>
            </section>
            
            {/* ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒƒãƒ— (å…ƒã®ã‚³ãƒ¼ãƒ‰ä¿æŒ) */}
            <section class="mt-8 pt-6 border-t border-slate-200">
                <h2 class="text-2xl font-bold">ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒƒãƒ—</h2>
                <div class="mt-4 aspect-video w-full overflow-hidden rounded-lg border border-slate-200">
                    {/* â˜…â˜…â˜… 403 ã‚¨ãƒ©ãƒ¼ä¿®æ­£æ¸ˆ: å…ƒã® .../1... ã«æˆ»ã—ã¾ã—ãŸ â˜…â˜…â˜… */}
                    <iframe width="100%" height="100%" style="border:0" loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade" src={`https://www.google.com/maps/embed/v1/place?key=$${import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY}&q=${encodeURIComponent(name + " " + address)}`}></iframe>
                </div>
            </section>

            {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ãƒ©ãƒƒãƒ‘ãƒ¼ (å…ƒã®ã‚³ãƒ¼ãƒ‰ä¿æŒ) */}
            <div id="review-form-wrapper" class="hidden">
                <ReviewSection range={range} />
            </div>
        </div>
    </main>
</BaseLayout>


{/* â˜…â˜…â˜… ä¿®æ­£æ¸ˆ B-2 (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ) â˜…â˜…â˜… */}
{/* SyntaxErrorã‚’å›é¿ã™ã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼å´ã§æ§‹ç¯‰ã—ãŸ "passedConfig" ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚Šã¾ã™ã€‚*/}
{/* ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å‹•çš„å–å¾—ãƒ»æç”»ã€ã€Œãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®å†æç”»ã€ã€Œãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºã€ã€Œã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤ºã€ã®ã™ã¹ã¦ã‚’å‡¦ç†ã—ã¾ã™ã€‚*/}
<script define:vars={{ rangeId: range.id, passedConfig: clientFirebaseConfig }}>

    // Firebaseã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆSDKãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‹•çš„ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    async function getFirebaseModules() {
        // â˜…â˜…â˜… SyntaxError ä¿®æ­£ â˜…â˜…â˜…
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸ 'passedConfig' (ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ã§å®šç¾©) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
        // ã“ã‚Œã§ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å´ï¼‰ã‹ã‚‰ "import.meta.env" ã®å‘¼ã³å‡ºã—ãŒä¸€åˆ‡ãªããªã‚Šã¾ã™ã€‚
        const firebaseConfig = passedConfig; 
        
        // å¿…è¦ãªé–¢æ•°ã‚’ã™ã¹ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const { initializeApp } = await import('firebase/app');
        const { getFirestore, collection, getDocs, query, orderBy, Timestamp } = await import('firebase/firestore');

        // appId ã‚‚ passedConfig ã‹ã‚‰å–å¾—
        const appId = passedConfig.appId;

        return { initializeApp, getFirestore, collection, getDocs, query, orderBy, Timestamp, firebaseConfig, appId };
    }
    
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
    const escapeHTML = (str) => {
        if (typeof str !== 'string' || !str) return '';
        return str.replace(/[&<>"']/g, (match) => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[match]));
    };

    // å…ƒã®ç”»åƒURLã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•° (ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ã‚‚å¿…è¦)
    function getPublicUrl(originalUrl) {
        if (!originalUrl) return '';
        const urlParts = originalUrl.split('?');
        const path = urlParts[0];
        return `${path}?alt=media`;
    }

    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰HTMLè¦ç´ ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (XSSå¯¾ç­–é©ç”¨æ¸ˆã¿)
    function createReviewArticle(review) {
        const article = document.createElement('article');
        article.className = 'border-b border-slate-200 pb-6';

        const ratingVal = review.rating ? Math.round(review.rating) : 0;
        const stars = 'â˜…'.repeat(ratingVal) + 'â˜†'.repeat(5 - ratingVal);
        
        let date = 'æ—¥ä»˜ä¸æ˜';
        try {
            if (review.createdAt?.toDate) {
                date = review.createdAt.toDate().toLocaleDateString('ja-JP');
            } else if (review.createdAt && review.createdAt.seconds) {
                // Firestoreã®TimestampãŒJSONã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                date = new Date(review.createdAt.seconds * 1000).toLocaleDateString('ja-JP');
            }
        } catch (e) {
            console.warn("æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤±æ•—:", review.createdAt);
        }

        const isAdminReview = review.author === "é–¢ï¼ ã‚·ã‚¬ã‚´ãƒ«ç®¡ç†äºº";

        // å®‰å…¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆ
        const safeTitle = escapeHTML(review.title || '');
        const safeBody = review.body ? escapeHTML(review.body).replace(/\n/g, '<br>') : ''; // æ”¹è¡Œã®ã¿è¨±å¯
        const safeAuthor = escapeHTML(review.author || 'åŒ¿å');

        let imagesHTML = '';
        if (review.imageUrls && review.imageUrls.length > 0) {
            imagesHTML = `<div class="mt-4 flex flex-wrap gap-3">${
                review.imageUrls.map(url => {
                    const publicUrl = getPublicUrl(url); // ãƒˆãƒ¼ã‚¯ãƒ³é™¤å»
                    return `<a href="${publicUrl}" target="_blank" rel="noopener noreferrer" class="block"><img src="${publicUrl}" alt="æŠ•ç¨¿å†™çœŸ" class="w-28 h-28 sm:w-32 sm:h-32 md:w-40 md:h-40 object-cover rounded-md hover:opacity-80 transition" loading="lazy" /></a>`
                }).join('')
            }</div>`;
        }
        
        let scoresHTML = '';
        if (isAdminReview && review.scores) {
            // scoresã®ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ data-scores å±æ€§ã«ã‚»ãƒƒãƒˆ
            const safeScoresData = escapeHTML(JSON.stringify(review.scores));
            scoresHTML = `<div class="my-4 max-w-sm mx-auto"><canvas class="radar-chart-canvas" data-scores='${safeScoresData}'></canvas></div>`;
        }
        
        const safeRatingString = escapeHTML(String(review.rating || 'N/A'));
        article.innerHTML = `
            <div class="flex items-center gap-x-4">
                <div class="text-amber-500 text-xl" title="${safeRatingString}ã¤æ˜Ÿ">${stars}</div>
                ${isAdminReview ? `<span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">å…¬å¼ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>` : ''}
            </div>
            <h3 class="text-lg font-bold mt-2">${safeTitle}</h3>
            ${scoresHTML}
            <p class="text-slate-600 my-4 whitespace-pre-wrap">${safeBody}</p>
            ${imagesHTML}
            <p class="text-sm text-slate-400 text-right mt-4">æŠ•ç¨¿è€…: ${safeAuthor} / æŠ•ç¨¿æ—¥: ${date}</p>
        `;
        return article;
    }

    // Chart.jsã§ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»ã™ã‚‹é–¢æ•° (å…ƒã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰)
    async function renderRadarCharts() {
        if (typeof Chart === 'undefined') {
             // Chart.jsãŒBaseLayout.astroãªã©ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã™
             console.error("Chart.js ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
             return;
        }
        
        document.querySelectorAll('.radar-chart-canvas').forEach(canvas => {
            if (canvas.chart) return; // æ—¢ã«ãƒãƒ£ãƒ¼ãƒˆãŒæç”»ã•ã‚Œã¦ã„ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
            try {
                const scoresData = JSON.parse(canvas.dataset.scores);
                const chart = new Chart(canvas, {
                    type: 'radar',
                    data: { labels: Object.keys(scoresData), datasets: [{ label: 'è©•ä¾¡ã‚¹ã‚³ã‚¢', data: Object.values(scoresData), fill: true, backgroundColor: 'rgba(34, 197, 94, 0.2)', borderColor: 'rgb(22, 163, 74)', pointBackgroundColor: 'rgb(22, 163, 74)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgb(22, 163, 74)' }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { r: { angleLines: { display: false }, suggestedMin: 0, suggestedMax: 5, pointLabels: { font: { size: 10 } } } }, plugins: { legend: { display: false } } }
                });
                canvas.chart = chart; // æç”»æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
            } catch (e) {
                console.error("ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®æç”»ã«å¤±æ•—:", e, canvas.dataset.scores);
            }
        });
    }

    // ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—ã—ã¦æç”»
    async function loadReviews() {
        const reviewsListContainer = document.getElementById('reviews-list');
        if (!reviewsListContainer) return;
        
        try {
            // â˜…â˜…â˜… ä¿®æ­£: appId ã‚’ getFirebaseModules ã‹ã‚‰å—ã‘å–ã‚‹ â˜…â˜…â˜…
            const { initializeApp, getFirestore, collection, getDocs, query, orderBy, firebaseConfig, appId } = await getFirebaseModules();
            
            // FirebaseAppãŒæ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª (Astroã®HMRå¯¾ç­–ãªã©ã‚‚å…¼ã­ã‚‹)
            let app;
            // Astroã§ã¯ `getApps()` ãŒæ¨™æº–çš„ã ãŒã€å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ã¯åˆ©ç”¨ã—ã¥ã‚‰ã„ãŸã‚ã€ç°¡æ˜“çš„ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒã‚§ãƒƒã‚¯
            if (!window._firebaseApp) {
                 window._firebaseApp = initializeApp(firebaseConfig);
            }
            app = window._firebaseApp;
            const db = getFirestore(app);

            // â˜…â˜…â˜… ä¿®æ­£: getFirebaseModules ã‹ã‚‰æ¥ãŸ appId ã‚’ä½¿ç”¨ â˜…â˜…â˜…
            const publicDataPath = `artifacts/${appId}/public/data`;
            // â˜…â˜…â˜… å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨ä¸€è‡´ã™ã‚‹æ­£ã—ã„ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã‚’ä½¿ç”¨ â˜…â˜…â˜…
            const reviewsCollectionRef = collection(db, publicDataPath, 'practice_ranges', rangeId, 'reviews');
            
            const q = query(reviewsCollectionRef, orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);

            reviewsListContainer.innerHTML = ''; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’æ¶ˆå»

            if (querySnapshot.empty) {
                reviewsListContainer.innerHTML = `<p id="no-reviews-message" class="text-center text-slate-500 py-8">ã“ã®ç·´ç¿’å ´ã«ã¯ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                return;
            }

            // å…ƒã®ã‚³ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¸è¥²: ç®¡ç†äººãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ä¸€èˆ¬ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åˆ†ã‘ã€ç®¡ç†äººãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å…ˆé ­ã«ã™ã‚‹
            const adminReviews = [];
            const userReviews = [];
            querySnapshot.forEach(doc => {
                 const review = doc.data();
                 if (review.author === "é–¢ï¼ ã‚·ã‚¬ã‚´ãƒ«ç®¡ç†äºº") {
                    adminReviews.push(review);
                 } else {
                    userReviews.push(review);
                 }
            });
            
            const sortedReviews = [...adminReviews, ...userReviews]; // ç®¡ç†äººã‚’å…ˆé ­ã«

            // DOMã«ä¸€æ‹¬è¿½åŠ  (DocumentFragmentã‚’ä½¿ã£ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š)
            const fragment = document.createDocumentFragment();
            sortedReviews.forEach(review => {
                const article = createReviewArticle(review);
                fragment.appendChild(article);
            });
            reviewsListContainer.appendChild(fragment);
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæç”»ã•ã‚ŒãŸå¾Œã«ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»ã™ã‚‹
            await renderRadarCharts();

        } catch (error) {
            console.error("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            if (reviewsListContainer) {
                 reviewsListContainer.innerHTML = `<p class="text-center text-red-600 py-8">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
            }
        }
    }

    // å…ƒã®ã‚³ãƒ¼ãƒ‰ã«ã‚ã£ãŸé™çš„ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼‰
    function initializeStaticScripts() {
        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        const showButton = document.getElementById("show-review-form-btn");
        const formWrapper = document.getElementById("review-form-wrapper");
        if (showButton && formWrapper) {
            showButton.addEventListener("click", () => {
                formWrapper.classList.remove("hidden");
                showButton.style.display = "none";
                formWrapper.scrollIntoView({ behavior: "smooth" });
            });
        }

        // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€æ©Ÿèƒ½
        const galleryItems = document.querySelectorAll('.gallery-item');
        const showMoreBtn = document.getElementById('show-more-gallery-btn');
        if (galleryItems.length > 0) {
            galleryItems.forEach((item, index) => {
                if (index < 8) item.classList.remove('hidden');
            });
        }
        if (showMoreBtn) {
            showMoreBtn.addEventListener('click', () => {
                galleryItems.forEach((item, index) => {
                    if (index >= 8) item.classList.remove('hidden');
                });
                showMoreBtn.style.display = 'none';
            });
        }
    }
    
    // â˜…â˜…â˜… ãƒ¡ã‚¤ãƒ³ã®å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
    document.addEventListener('DOMContentLoaded', () => {
        // 1. ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»¥å¤–ã®é™çš„ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã€ã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼‰ã‚’åˆæœŸåŒ–
        initializeStaticScripts();

        // 2. ãƒ¡ã‚¤ãƒ³ã®æ©Ÿèƒ½ã§ã‚ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å‹•çš„èª­ã¿è¾¼ã¿ã‚’é–‹å§‹
        loadReviews();
    });

    // â˜…â˜…â˜… å³æ™‚åæ˜ ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
    // ReviewSectionå´ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿æˆåŠŸæ™‚ã« 'reviewPosted' ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã—ã¦ã„ã‚‹å‰æ
    document.addEventListener('reviewPosted', (event) => {
        console.log('æ–°è¦ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã‚’æ¤œçŸ¥:', event.detail);
        const newReviewData = event.detail;
        const reviewsListContainer = document.getElementById('reviews-list');
        const noReviewsEl = document.getElementById('no-reviews-message');

        if (!reviewsListContainer) return;

        // ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        if (noReviewsEl) {
            noReviewsEl.remove();
        }

        // æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLã‚’ä½œæˆ
        const article = createReviewArticle(newReviewData);
        
        // ãƒªã‚¹ãƒˆã®å…ˆé ­ã«è¿½åŠ 
        reviewsListContainer.prepend(article);

        // ã‚‚ã—è¿½åŠ ã—ãŸã®ãŒç®¡ç†äººãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã‚‰ãƒãƒ£ãƒ¼ãƒˆã‚‚æç”»
        if (newReviewData.author === "é–¢ï¼ ã‚·ã‚¬ã‚´ãƒ«ç®¡ç†äºº" && newReviewData.scores) {
             renderRadarCharts(); // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸcanvasã‚’æ¢ã—ã¦æç”»
        }
    });

</script>