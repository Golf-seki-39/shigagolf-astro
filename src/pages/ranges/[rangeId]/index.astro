---
// â˜…â˜…â˜… [rangeId].astro - å®Œå…¨ç‰ˆ (LCPæœ€é©åŒ– + chart.js + ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ä¿®æ­£) â˜…â˜…â˜…

import BaseLayout from "../../../layouts/BaseLayout.astro";
import ReviewSection from "../../../components/ReviewSection.astro";
import { db } from "../../../lib/firebase.js";
import { Image } from "astro:assets";
import { collection, getDocs } from "firebase/firestore";

// 1. getStaticPaths: ãƒ“ãƒ«ãƒ‰æ™‚ã«å„ç·´ç¿’å ´ã®ãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ‘ã‚¹ã¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
export async function getStaticPaths() {
    const appId = import.meta.env.PUBLIC_FIREBASE_APP_ID;
    const publicDataPath = `artifacts/${appId}/public/data`;
    const rangesCollection = collection(db, publicDataPath, 'practice_ranges');
    const querySnapshot = await getDocs(rangesCollection);

   // 'image_archive' ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é™¤å¤–ã—ã¦ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
   const paths = querySnapshot.docs
        .filter(doc => doc.id !== 'image_archive')
        .map(doc => ({
            params: { rangeId: doc.id }, // URLã® [rangeId] éƒ¨åˆ†
            props: { range: { id: doc.id, ...doc.data() } } // ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã™ãƒ‡ãƒ¼ã‚¿
        }));
    return paths;
}

// 2. Props ã¨é™çš„å¤‰æ•°ã®å®šç¾©
const { range } = Astro.props; // getStaticPathsã‹ã‚‰æ¸¡ã•ã‚ŒãŸç·´ç¿’å ´ãƒ‡ãƒ¼ã‚¿
// ç·´ç¿’å ´ãƒ‡ãƒ¼ã‚¿ã®å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¤‰æ•°ã«å±•é–‹ (galleryImagesã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç©ºé…åˆ—)
const {
    id, name, address, phone, business_hours, website, scores, area, city, postalCode, reviewCount, avgRating, imageUrl,
    isIndoor = false, is_beginner_friendly = false, hasTracer = false, tracer_brand, tags = [], galleryImages= [],
    yardage, bays, hasApproach = false, hasBunker = false, hasPutter = false, hasUchihodai = false,
    price_ball_weekday_str, price_ball_weekend_str, price_uchihodai_weekday_str, price_uchihodai_weekend_str,
    approach_fee_info, bunker_fee_info, payment_methods, initial_cost, access, parking_info,
    rental_club_info, lefty_bays_info, managerReviewUrl
} = range;

// ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜æ–‡
const title = `${name}ã®å£ã‚³ãƒŸãƒ»è©•åˆ¤ | ã‚·ã‚¬ã‚´ãƒ«`;
const description = `${name}ï¼ˆ${area || 'æ»‹è³€çœŒ'}ã‚¨ãƒªã‚¢ï¼‰ã®å£ã‚³ãƒŸãƒ»è©•åˆ¤ã‚’ãƒã‚§ãƒƒã‚¯ã€‚æ–™é‡‘ã€è¨­å‚™ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã©ã€${name}ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ãŒæº€è¼‰ã§ã™ã€‚`;

// ãƒãƒƒã‚¸è¡¨ç¤ºç”¨ã®é…åˆ—ã‚’ä½œæˆ
const badges = [];
if (isIndoor) badges.push("ã‚¤ãƒ³ãƒ‰ã‚¢");
if (is_beginner_friendly) badges.push("åˆå¿ƒè€…ã«å„ªã—ã„");
if (hasTracer && tracer_brand === "ãƒˆãƒƒãƒ—ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼") badges.push("å…¨æ‰“å¸­ãƒˆãƒƒãƒ—ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼");
else if (hasTracer) badges.push("å¼¾é“æ¸¬å®šå™¨ã‚ã‚Š");
if (tags && tags.includes("GPä½µè¨­")) badges.push("GPä½µè¨­");

// ã‚®ãƒ£ãƒ©ãƒªãƒ¼ç”»åƒã‚’ isFeatured ã§ã‚½ãƒ¼ãƒˆ (é…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼)
(Array.isArray(galleryImages) ? galleryImages : []).sort((a, b) => (b.isFeatured ? 1 : 0) - (a.isFeatured ? 1 : 0));

// JSON-LDæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ (SEOç”¨)
const ldJson = {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    name: name,
    image: imageUrl, // ãƒ¡ã‚¤ãƒ³ç”»åƒURL
    telephone: phone,
    address: {
        "@type": "PostalAddress",
        streetAddress: address,
        addressLocality: city,
        addressRegion: "æ»‹è³€çœŒ",
        postalCode: postalCode,
        addressCountry: "JP",
    },
    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚‹å ´åˆã®ã¿è©•ä¾¡æƒ…å ±ã‚’è¿½åŠ 
    ...(reviewCount > 0 && {
        aggregateRating: {
            "@type": "AggregateRating",
            ratingValue: avgRating ? parseFloat(avgRating).toFixed(1) : undefined, // æ•°å€¤ã«å¤‰æ›
            reviewCount: reviewCount,
        },
    }),
};

// Firebase Storageã®URLã‹ã‚‰ ?alt=media ã‚’ä»˜ä¸ã™ã‚‹é–¢æ•°
function getPublicUrl(originalUrl) {
    if (!originalUrl || typeof originalUrl !== 'string') return '';
    const urlParts = originalUrl.split('?');
    const path = urlParts[0];
    // ã™ã§ã« ?alt=media ãŒã¤ã„ã¦ã„ã‚‹å ´åˆã¯ãã®ã¾ã¾è¿”ã™
    if (urlParts.length > 1 && urlParts[1].includes('alt=media')) {
      return originalUrl;
    }
    // ? ä»¥é™ã‚’é™¤å»ã—ã¦ ?alt=media ã‚’ä»˜ä¸
    return `${path}?alt=media`;
}


// Firebase Config (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”¨)
const clientFirebaseConfig = {
    apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
    authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
    projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
    storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
    appId: import.meta.env.PUBLIC_FIREBASE_APP_ID,
};
---

{/* chart.js ã®æ¡ä»¶ä»˜ãèª­ã¿è¾¼ã¿ (ã“ã®ãƒšãƒ¼ã‚¸ã§ã®ã¿headã«è¿½åŠ ) */}
<Fragment slot="head">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</Fragment>

<BaseLayout title={title} description={description}>
    {/* SEOç”¨JSON-LD */}
    <script type="application/ld+json" set:html={JSON.stringify(ldJson)} />

    <main class="container mx-auto p-4 md:p-6">
        {/* æˆ»ã‚‹ãƒªãƒ³ã‚¯ */}
        <div class="mb-4">
            <a href="/" class="text-green-700 font-semibold hover:underline">
                â€¹ ç·´ç¿’å ´ä¸€è¦§ã«æˆ»ã‚‹
            </a>
        </div>

        <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">

            {/* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
            <header>
               {/* ãƒ¡ã‚¤ãƒ³ç”»åƒ (LCPæœ€é©åŒ–æ¸ˆã¿) */}
               {imageUrl && (
                 <Image
                    src={imageUrl}
                    alt={`${name}ã®å¤–è¦³`}
                    class="w-full h-64 object-cover rounded-lg mb-6"
                    width={1200}
                    height={630}
                    format="webp"
                    loading="eager"      {/* LCPè¦ç´ ãªã®ã§ eager */}
                    fetchpriority="high" {/* LCPè¦ç´ ãªã®ã§ high */}
                />
               )}
                {/* ç·´ç¿’å ´åã€ã‚¨ãƒªã‚¢ã€ãƒãƒƒã‚¸ */}
                <div>
                    <p class="text-lg text-green-700 font-semibold">{area || 'æ»‹è³€çœŒ'}ã‚¨ãƒªã‚¢</p> {/* ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆä¿®æ­£ */}
                    <h1 class="text-4xl font-bold mt-1">{name}</h1>
                    {badges.length > 0 && (
                        <div class="mt-4 flex flex-wrap gap-2">
                            {badges.map((badge) => (
                                <span class="text-sm bg-blue-100 text-blue-800 font-semibold px-3 py-1 rounded-full">{badge}</span>
                            ))}
                        </div>
                    )}
                </div>
                {/* ãƒ¤ãƒ¼ãƒ‰æ•°ã€æ‰“å¸­æ•° */}
                <div class="my-6 grid grid-cols-2 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden text-center">
                    <div class="bg-white p-4">
                        <p class="text-sm text-slate-500">ãƒ¤ãƒ¼ãƒ‰æ•°</p>
                        <p class="text-2xl font-bold">{isIndoor ? <span class="whitespace-nowrap">ï¼ˆã‚¤ãƒ³ãƒ‰ã‚¢ï¼‰</span> : yardage ? `${yardage}yd` : "-"}</p>
                    </div>
                    <div class="bg-white p-4">
                        <p class="text-sm text-slate-500">æ‰“å¸­æ•°</p>
                        <p class="text-2xl font-bold">{bays ? `${bays}æ‰“å¸­` : "-"}</p>
                    </div>
                </div>
            </header>

            {/* ãƒ•ã‚©ãƒˆã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
            {galleryImages && galleryImages.length > 0 && (
              <section class="mt-8 pt-6 border-t border-slate-200">
                <h2 class="text-2xl font-bold">ãƒ•ã‚©ãƒˆã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
                <div id="gallery-grid" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                  {galleryImages.map((image, index) => (
                    // å„ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚¢ã‚¤ãƒ†ãƒ 
                    <div class="gallery-item hidden">
                      <a href={getPublicUrl(image?.url)} target="_blank" rel="noopener noreferrer" class="block aspect-square group">
                        {/* URLãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç”»åƒã‚’è¡¨ç¤º */}
                        {image?.url && (
                          <Image
                            src={getPublicUrl(image.url)}
                            alt={`${name}ã®ã‚®ãƒ£ãƒ©ãƒªãƒ¼å†™çœŸ ${index + 1}ï¼ˆæŠ•ç¨¿è€…: ${image.author || 'ä¸æ˜'}ï¼‰ ${image.description || ''}`}
                            class="w-full h-full object-cover rounded-lg group-hover:opacity-80 transition-opacity"
                            width={400}
                            height={400}
                            format="webp"
                            fit="cover"    {/* CSSã®object-coverã¨åˆã‚ã›ã‚‹ */}
                            loading="lazy" {/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ã¨è¦‹ãˆãªã„ã®ã§ lazy */}
                            quality={60}   {/* å“è³ªã‚’å°‘ã—ä¸‹ã’ã¦è»½é‡åŒ– */}
                          />
                        )}
                      </a>
                    </div>
                  ))}
                </div>
                {/* ã‚‚ã£ã¨è¦‹ã‚‹ãƒœã‚¿ãƒ³ */}
                {galleryImages.length > 8 && (
                  <div class="mt-6 text-center">
                    <button id="show-more-gallery-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition">ã‚‚ã£ã¨è¦‹ã‚‹</button>
                  </div>
                )}
              </section>
            )}

            {/* æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (è¨­å‚™ã€æ–™é‡‘ã€åŸºæœ¬æƒ…å ±ã€é–¢é€£ãƒªãƒ³ã‚¯) */}
            <div class="mt-8 pt-6 border-t border-slate-200 space-y-8">
                {/* è¨­å‚™æƒ…å ± */}
                <section>
                    <h2 class="text-2xl font-bold">è¨­å‚™æƒ…å ±</h2>
                    <ul class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-4 text-slate-600">
                        <li>ğŸ“¡ å¼¾é“æ¸¬å®šå™¨: {hasTracer ? `ã‚ã‚Š (${tracer_brand || 'æ©Ÿç¨®ä¸æ˜'})` : "ãªã—"}</li>
                        <li>â›³ï¸ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: {hasApproach ? "ã‚ã‚Š" : "ãªã—"}</li>
                        <li>ğŸ•³ï¸ ãƒãƒ³ã‚«ãƒ¼: {hasBunker ? "ã‚ã‚Š" : "ãªã—"}</li>
                        <li>ğŸŒï¸ ãƒ‘ã‚¿ãƒ¼: {hasPutter ? "ã‚ã‚Š" : "ãªã—"}</li>
                        <li>ğŸ’° æ‰“ã¡æ”¾é¡Œ: {hasUchihodai ? "ã‚ã‚Š" : "ãªã—"}</li>
                    </ul>
                </section>

                {/* æ–™é‡‘æƒ…å ± */}
                <section>
                    <h2 class="text-2xl font-bold">æ–™é‡‘æƒ…å ±</h2>
                    <div class="mt-2 overflow-x-auto border border-slate-200 rounded-lg">
                        <table class="min-w-full text-sm">
                            <tbody class="text-slate-600">
                                {/* å±‹å¤–ç·´ç¿’å ´ã®ã¿çƒå˜ä¾¡ã‚’è¡¨ç¤º */}
                                {!isIndoor && (
                                    <>
                                        <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 w-1/3 whitespace-nowrap">çƒå˜ä¾¡ï¼ˆå¹³æ—¥ï¼‰</th><td class="py-3 px-4" set:html={price_ball_weekday_str ? price_ball_weekday_str.replace(/\//g, "<br>").replace(/\(/g, "<br>(") : "æƒ…å ±ãªã—"} /></tr>
                                        <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">çƒå˜ä¾¡ï¼ˆåœŸæ—¥ç¥ï¼‰</th><td class="py-3 px-4" set:html={price_ball_weekend_str ? price_ball_weekend_str.replace(/\//g, "<br>").replace(/\(/g, "<br>(") : "æƒ…å ±ãªã—"} /></tr>
                                    </>
                                )}
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">æ‰“ã¡æ”¾é¡Œï¼ˆå¹³æ—¥ï¼‰</th><td class="py-3 px-4" set:html={hasUchihodai ? (price_uchihodai_weekday_str ? price_uchihodai_weekday_str.replace(/\//g, "<br>").replace(/\(/g, "<br>(") : "æƒ…å ±ãªã—") : "æ‰“æ”¾é¡Œãªã—"} /></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">æ‰“ã¡æ”¾é¡Œï¼ˆåœŸæ—¥ç¥ï¼‰</th><td class="py-3 px-4" set:html={hasUchihodai ? (price_uchihodai_weekend_str ? price_uchihodai_weekend_str.replace(/\//g, "<br>").replace(/\(/g, "<br>(") : "æƒ…å ±ãªã—") : "æ‰“æ”¾é¡Œãªã—"} /></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç·´ç¿’å ´</th><td class="py-3 px-4">{approach_fee_info || (hasApproach ? "ä½µè¨­ï¼ˆæ–™é‡‘è¦ç¢ºèªï¼‰" : "ãªã—")}</td></tr>
                                <tr><th class="py-3 px-4 text-left font-semibold bg-slate-50 whitespace-nowrap">ãƒãƒ³ã‚«ãƒ¼ç·´ç¿’å ´</th><td class="py-3 px-4">{bunker_fee_info || (hasBunker ? "ä½µè¨­ï¼ˆæ–™é‡‘è¦ç¢ºèªï¼‰" : "ãªã—")}</td></tr>
                            </tbody>
                        </table>
                    </div>
                    {/* æ”¯æ‰•ã„æ–¹æ³•ã€æœ€ä½æ–™é‡‘ç›®å®‰ */}
                    <ul class="mt-4 space-y-2 text-slate-600 text-sm">
                        <li><strong>æ”¯æ‰•ã„æ–¹æ³•:</strong> {payment_methods || "æƒ…å ±ãªã—"}</li>
                        <li><strong>æœ€ä½æ–™é‡‘ã®ç›®å®‰:</strong> {initial_cost || "æƒ…å ±ãªã—"}</li>
                    </ul>
                </section>

                {/* åŸºæœ¬æƒ…å ± */}
                <section>
                    <h2 class="text-2xl font-bold">åŸºæœ¬æƒ…å ±</h2>
                    <div class="mt-2 overflow-x-auto border border-slate-200 rounded-lg">
                        <table class="min-w-full text-sm">
                            <tbody class="text-slate-600">
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50 w-1/4 whitespace-nowrap">å–¶æ¥­æ™‚é–“</th><td class="py-3 px-4" set:html={business_hours?.replace(/\n/g, '<br />') || "æƒ…å ±ãªã—"} /></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50">ä½æ‰€</th><td class="py-3 px-4"><a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address || '')}`} target="_blank" rel="noopener noreferrer" class="text-green-700 hover:underline">{address || "æƒ…å ±ãªã—"}</a></td></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50">é›»è©±ç•ªå·</th><td class="py-3 px-4">{phone ? <a href={`tel:${phone.replace(/-/g, "")}`} class="text-green-700 hover:underline">{phone}</a> : "æƒ…å ±ãªã—"}</td></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50">ã‚¢ã‚¯ã‚»ã‚¹</th><td class="py-3 px-4">{access || "æƒ…å ±ãªã—"}</td></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50">é§è»Šå ´</th><td class="py-3 px-4">{parking_info || "æƒ…å ±ãªã—"}</td></tr>
                                <tr class="border-b border-slate-200"><th class="py-3 px-4 text-left font-semibold bg-slate-50">ãƒ¬ãƒ³ã‚¿ãƒ«ã‚¯ãƒ©ãƒ–</th><td class="py-3 px-4">{rental_club_info || "æƒ…å ±ãªã—"}</td></tr>
                                <tr><th class="py-3 px-4 text-left font-semibold bg-slate-50">å·¦åˆ©ãæ‰“å¸­</th><td class="py-3 px-4">{lefty_bays_info || "æƒ…å ±ãªã—"}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                {/* é–¢é€£ãƒªãƒ³ã‚¯ */}
                <section>
                    <h2 class="text-2xl font-bold">é–¢é€£ãƒªãƒ³ã‚¯</h2>
                    <div class="mt-2 space-y-3">
                        {/* ç®¡ç†äººãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸ã®ãƒªãƒ³ã‚¯ */}
                        {managerReviewUrl && (
                          <a href={managerReviewUrl} target="_blank" rel="noopener noreferrer" class="flex items-center gap-x-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition group border">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <span class="font-semibold text-slate-800 group-hover:underline">ã“ã®ç·´ç¿’å ´ã®ç®¡ç†äººã®ä½“é¨“è«‡ã‚’è¦‹ã‚‹</span>
                          </a>
                        )}
                        {/* ãŠå½¹ç«‹ã¡æƒ…å ±ä¸€è¦§ã¸ã®ãƒªãƒ³ã‚¯ */}
                        <a href="/articles/" class="flex items-center gap-x-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition group border">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3h2m0 0h2m-2 0V5m0 2v2m0 0h2"/></svg>
                           <span class="font-semibold text-slate-800 group-hover:underline">ãŠå½¹ç«‹ã¡æƒ…å ±ä¸€è¦§</span>
                        </a>
                        {/* å…¬å¼ã‚µã‚¤ãƒˆã¸ã®ãƒªãƒ³ã‚¯ */}
                        {website && (
                          <a href={website} target="_blank" rel="noopener noreferrer" class="flex items-center gap-x-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition group border">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                            <span class="font-semibold text-slate-800 group-hover:underline">å…¬å¼ã‚µã‚¤ãƒˆ</span>
                          </a>
                        )}
                    </div>
                </section>
            </div>

            {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ããƒœã‚¿ãƒ³ */}
            <div class="my-8 text-center">
                <button id="show-review-form-btn" class="bg-amber-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-amber-700 transition text-lg">ã“ã®ç·´ç¿’å ´ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã</button> {/* ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆä¿®æ­£ */}
            </div>

            {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
            <section class="mt-8 pt-6 border-t border-slate-200">
                <h2 class="text-2xl font-bold mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰JSã§æç”» */}
                <div id="reviews-list" class="space-y-6">
                    <div id="loading-reviews" class="text-center py-8">
                        <p class="text-slate-500">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                    </div>
                </div>
            </section>

            {/* ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
            <section class="mt-8 pt-6 border-t border-slate-200">
                <h2 class="text-2xl font-bold">ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒƒãƒ—</h2>
                <div class="mt-4 aspect-video w-full overflow-hidden rounded-lg border border-slate-200">
                    {/* â˜…â˜…â˜… iframeã« title ã‚’è¿½åŠ  â˜…â˜…â˜… */}
                    <iframe
                        title="ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒƒãƒ—"
                        width="100%"
                        height="100%"
                        style="border:0;"
                        loading="lazy"
                        allowfullscreen=""
                        referrerpolicy="no-referrer-when-downgrade"
                        src={`https://www.google.com/maps/embed/v1/place?key=${import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY}&q=${encodeURIComponent(name + " " + address)}`}>
                    </iframe>
                </div>
            </section>

            {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  (åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º) */}
            <div id="review-form-wrapper" class="hidden">
                <ReviewSection range={range} /> {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */}
            </div>
        </div>
    </main>
</BaseLayout>


{/* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰JavaScript */}
<script define:vars={{ rangeId: range.id, passedConfig: clientFirebaseConfig }}>

    // --- Firebase Modulesã®é…å»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ---
    async function getFirebaseModules() {
        const [
            { initializeApp },
            { getFirestore, collection, query, orderBy, getDocs }
        ] = await Promise.all([
            import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js'),
            import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js')
        ]);
        return { initializeApp, getFirestore, collection, query, orderBy, getDocs };
    }

    // --- HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•° ---
    const escapeHTML = (str) => {
        if (typeof str !== 'string' || !str) return '';
        return str.replace(/[&<>"']/g, (match) => ({
            '&': '&amp;', // '&' ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        }[match]));
    };

    // --- å…¬é–‹URLå–å¾—é–¢æ•° ---
    function getPublicUrl(originalUrl) {
        if (!originalUrl || typeof originalUrl !== 'string') return '';
        const urlParts = originalUrl.split('?');
        const path = urlParts[0];
        // ã™ã§ã« ?alt=media ãŒã¤ã„ã¦ã„ã‚‹å ´åˆã¯ãã®ã¾ã¾è¿”ã™
        if (urlParts.length > 1 && urlParts[1].includes('alt=media')) {
          return originalUrl;
        }
        return `${path}?alt=media`;
    }


    // --- ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨˜äº‹HTMLç”Ÿæˆé–¢æ•° ---
    function createReviewArticle(review) {
        const article = document.createElement('article');
        article.className = 'border-b border-slate-200 pb-6';
        const ratingVal = review?.rating ? Math.round(review.rating) : 0; // ?. ã§å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹
        const stars = 'â˜…'.repeat(ratingVal) + 'â˜†'.repeat(5 - ratingVal);
        let date = 'æ—¥ä»˜ä¸æ˜';
        try {
             if (review?.createdAt && typeof review.createdAt.toDate === 'function') { date = review.createdAt.toDate().toLocaleDateString('ja-JP'); } else if (review?.createdAt && review.createdAt.seconds) { date = new Date(review.createdAt.seconds * 1000).toLocaleDateString('ja-JP'); } else if (review?.createdAt instanceof Date) { date = review.createdAt.toLocaleDateString('ja-JP'); }
        } catch (e) { console.warn("æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤±æ•—:", review?.createdAt); }
        const isAdminReview = review?.author === "é–¢ï¼ ã‚·ã‚¬ã‚´ãƒ«ç®¡ç†äºº";
        const safeTitle = escapeHTML(review?.title || '');
        const safeBody = review?.body ? escapeHTML(review.body).replace(/\n/g, '<br>') : '';
        const safeAuthor = escapeHTML(review?.author || 'åŒ¿å');

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®HTMLã‚’ç”Ÿæˆ
        let imagesHTML = '';
        if (review?.imageUrls && Array.isArray(review.imageUrls) && review.imageUrls.length > 0) {
            imagesHTML = `<div class="mt-4 flex flex-wrap gap-3">${
                // â˜…â˜…â˜… altå±æ€§ã‚’å¤‰æ›´ â˜…â˜…â˜…
                review.imageUrls.map((url, index) => {
                    if (!url) return ''; // URLãŒç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    const publicUrl = getPublicUrl(url);
                    // altã«ç•ªå·ã‚’è¿½åŠ ã—ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹
                    return `<a href="${publicUrl}" target="_blank" rel="noopener noreferrer" class="block"><img src="${publicUrl}" alt="æŠ•ç¨¿å†™çœŸ ${index + 1}" class="w-28 h-28 sm:w-32 sm:h-32 md:w-40 md:h-40 object-cover rounded-md hover:opacity-80 transition" loading="lazy" /></a>`
                }).join('')
            }</div>`;
        }

        // ç®¡ç†äººãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å ´åˆã€ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆç”¨ã®canvasã‚’è¿½åŠ 
        let scoresHTML = '';
        if (isAdminReview && review?.scores) {
            try {
                const safeScoresData = escapeHTML(JSON.stringify(review.scores)); // JSONæ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦ã‹ã‚‰ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                scoresHTML = `<div class="my-4 max-w-sm mx-auto"><canvas class="radar-chart-canvas" data-scores='${safeScoresData}'></canvas></div>`;
            } catch (e) { console.error("ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ã®JSONå¤‰æ›ã«å¤±æ•—:", e, review.scores); }
        }

        const safeRatingString = escapeHTML(String(review?.rating || 'N/A'));

        // è¨˜äº‹å…¨ä½“ã®HTMLã‚’çµ„ã¿ç«‹ã¦
        article.innerHTML = `
            <div class="flex items-center gap-x-4">
                <div class="text-amber-500 text-xl" title="${safeRatingString}ã¤æ˜Ÿ">${stars}</div>
                ${isAdminReview ? `<span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">å…¬å¼ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>` : ''}
            </div>
            <h3 class="text-lg font-bold mt-2">${safeTitle}</h3>
            ${scoresHTML}
            <p class="text-slate-600 my-4 whitespace-pre-wrap">${safeBody}</p>
            ${imagesHTML}
            {/* â˜…â˜…â˜… text-slate-500 ã«å¤‰æ›´ (ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆæ”¹å–„) â˜…â˜…â˜… */}
            <p class="text-sm text-slate-500 text-right mt-4">æŠ•ç¨¿è€…: ${safeAuthor} / æŠ•ç¨¿æ—¥: ${date}</p>
        `;
        return article;
    }

    // --- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæç”»é–¢æ•° ---
    function renderRadarCharts() {
        // Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ (BaseLayoutã§deferèª­ã¿è¾¼ã¿ã•ã‚Œã‚‹)
        if (typeof Chart === 'undefined') {
             console.log("Chart.js is not loaded yet...");
             return;
        }
        // ã¾ã æç”»ã•ã‚Œã¦ã„ãªã„canvasè¦ç´ ã‚’æ¢ã—ã¦ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
        document.querySelectorAll('.radar-chart-canvas:not(.chartjs-render-monitor)').forEach(canvas => {
            // canvasè¦ç´ ã« chart ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã™ã§ã«ã‚ã‚Œã°æç”»æ¸ˆã¿ã¨ã¿ãªã™
            if (canvas.chart) return;
            try {
                const scoresData = JSON.parse(canvas.dataset.scores);
                // Chart.jsã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€canvasè¦ç´ ã«ç´ä»˜ã‘ã‚‹
                const chart = new Chart(canvas, {
                    type: 'radar',
                    data: {
                        labels: Object.keys(scoresData), // å„è©•ä¾¡é …ç›®å
                        datasets: [{
                            label: 'è©•ä¾¡ã‚¹ã‚³ã‚¢',
                            data: Object.values(scoresData), // å„è©•ä¾¡ã‚¹ã‚³ã‚¢
                            fill: true,
                            backgroundColor: 'rgba(34, 197, 94, 0.2)', // ç·‘ (å¡—ã‚Šã¤ã¶ã—)
                            borderColor: 'rgb(22, 163, 74)',     // ç·‘ (ç·š)
                            pointBackgroundColor: 'rgb(22, 163, 74)', // ç·‘ (ç‚¹)
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(22, 163, 74)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãªã„
                        scales: {
                            r: { // ãƒ¬ãƒ¼ãƒ€ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«(æ”¾å°„è»¸)ã®è¨­å®š
                                angleLines: { display: true }, // è§’åº¦ç·šã‚’è¡¨ç¤º
                                suggestedMin: 0,
                                suggestedMax: 5,
                                ticks: { // ç›®ç››ã‚Šã®è¨­å®š
                                  stepSize: 1, // 1åˆ»ã¿
                                  backdropColor: 'rgba(255, 255, 255, 0.75)', // ç›®ç››ã‚ŠèƒŒæ™¯è‰²
                                  color: '#64748b', // ç›®ç››ã‚Šæ–‡å­—è‰² (slate-500)
                                },
                                pointLabels: { // é …ç›®ãƒ©ãƒ™ãƒ«ã®è¨­å®š
                                    font: { size: 10 },
                                    color: '#334155' // ãƒ©ãƒ™ãƒ«æ–‡å­—è‰² (slate-700)
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false } // å‡¡ä¾‹ã¯éè¡¨ç¤º
                        }
                    }
                });
                canvas.chart = chart; // æç”»æ¸ˆã¿ãƒ•ãƒ©ã‚°ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
            } catch (e) {
                console.error("ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®æç”»ã«å¤±æ•—:", e, canvas.dataset.scores);
                canvas.outerHTML = `<p class="text-center text-red-500 text-sm">ãƒãƒ£ãƒ¼ãƒˆæç”»ã‚¨ãƒ©ãƒ¼</p>`; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            }
        });
    }


    // --- Firestoreã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã‚€é–¢æ•° ---
    async function loadReviews() {
        const reviewsListContainer = document.getElementById('reviews-list');
        if (!reviewsListContainer) return; // ã‚³ãƒ³ãƒ†ãƒŠãŒãªã‘ã‚Œã°å‡¦ç†ä¸­æ–­

        try {
            // Firebaseãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’éåŒæœŸã§å–å¾—
            const { initializeApp, getFirestore, collection, query, orderBy, getDocs } = await getFirebaseModules();

            // Firebaseã‚¢ãƒ—ãƒªã®åˆæœŸåŒ– (ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³)
            let app;
            if (!window._firebaseAppV10) {
                 window._firebaseAppV10 = initializeApp(passedConfig);
            }
            app = window._firebaseAppV10;
            const db = getFirestore(app); // Firestoreã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—

            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ãƒ‘ã‚¹ã‚’æ§‹ç¯‰
            const appId = passedConfig.appId;
            const publicDataPath = `artifacts/${appId}/public/data`;
            const fullReviewPath = `${publicDataPath}/practice_ranges/${rangeId}/reviews`;
            const reviewsCollectionRef = collection(db, fullReviewPath);

            // createdAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§é™é †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹ã‚¯ã‚¨ãƒªã‚’ä½œæˆ
            const q = query(reviewsCollectionRef, orderBy("createdAt", "desc"));
            // ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
            const querySnapshot = await getDocs(q);

            reviewsListContainer.innerHTML = ''; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢

            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            if (querySnapshot.empty) {
                reviewsListContainer.innerHTML = `<p id="no-reviews-message" class="text-center text-slate-500 py-8">ã“ã®ç·´ç¿’å ´ã«ã¯ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                return;
            }

            // ç®¡ç†äººãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åˆ†ã‘ã‚‹
            const adminReviews = [];
            const userReviews = [];
            querySnapshot.forEach(doc => {
                 const review = doc.data();
                 // authorãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§åˆ¤å®š
                 if (review?.author === "é–¢ï¼ ã‚·ã‚¬ã‚´ãƒ«ç®¡ç†äºº") {
                    adminReviews.push(review);
                 } else {
                    userReviews.push(review);
                 }
            });

            // ç®¡ç†äººãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å…ˆé ­ã«ã—ã¦çµåˆ
            const sortedReviews = [...adminReviews, ...userReviews];

            // DocumentFragmentã‚’ä½¿ã£ã¦DOMæ“ä½œã‚’åŠ¹ç‡åŒ–
            const fragment = document.createDocumentFragment();
            sortedReviews.forEach(review => {
                if (review) { // reviewãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¨˜äº‹ã‚’ç”Ÿæˆ
                    const article = createReviewArticle(review);
                    fragment.appendChild(article);
                }
            });
            // çµ„ã¿ç«‹ã¦ãŸHTMLã‚’ä¸€æ‹¬ã§DOMã«è¿½åŠ 
            reviewsListContainer.appendChild(fragment);

            // Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚Œã°ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»ã€ãªã‘ã‚Œã°loadã‚¤ãƒ™ãƒ³ãƒˆå¾Œã«æç”»
            if (typeof Chart !== 'undefined') {
                renderRadarCharts();
            } else {
                // BaseLayoutã§Chart.jsãŒdeferèª­ã¿è¾¼ã¿ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
                window.addEventListener('load', renderRadarCharts, { once: true });
            }

        } catch (error) {
            console.error("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (reviewsListContainer) {
                 reviewsListContainer.innerHTML = `<p class="text-center text-red-600 py-8">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
            }
        }
    }

    // --- é™çš„è¦ç´ ã®åˆæœŸåŒ–é–¢æ•° (ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ãƒœã‚¿ãƒ³ã€ã‚‚ã£ã¨è¦‹ã‚‹ãƒœã‚¿ãƒ³) ---
    function initializeStaticScripts() {
        // ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºãƒœã‚¿ãƒ³
        const showButton = document.getElementById("show-review-form-btn");
        const formWrapper = document.getElementById("review-form-wrapper");
        if (showButton && formWrapper) {
            showButton.addEventListener("click", () => {
                formWrapper.classList.remove("hidden"); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                showButton.style.display = "none";      // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                formWrapper.scrollIntoView({ behavior: "smooth" }); // ãƒ•ã‚©ãƒ¼ãƒ ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            });
        }

        // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®ã‚‚ã£ã¨è¦‹ã‚‹ãƒœã‚¿ãƒ³
        const galleryItems = document.querySelectorAll('.gallery-item');
        const showMoreBtn = document.getElementById('show-more-gallery-btn');
        const initialVisibleCount = 8; // åˆæœŸè¡¨ç¤ºæ•°

        if (galleryItems.length > 0) {
            // åˆæœŸè¡¨ç¤ºåˆ†ã ã‘è¡¨ç¤º
            galleryItems.forEach((item, index) => {
                if (index < initialVisibleCount) {
                  item.classList.remove('hidden');
                } else {
                  item.classList.add('hidden'); // å¿µã®ãŸã‚éè¡¨ç¤ºã«
                }
            });
            // åˆæœŸè¡¨ç¤ºæ•°ä»¥ä¸‹ãªã‚‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            if (galleryItems.length <= initialVisibleCount) {
                if(showMoreBtn) showMoreBtn.style.display = 'none';
            }
        } else {
             if(showMoreBtn) showMoreBtn.style.display = 'none'; // ç”»åƒãŒãªã‘ã‚Œã°ãƒœã‚¿ãƒ³éè¡¨ç¤º
        }


        if (showMoreBtn) {
            showMoreBtn.addEventListener('click', () => {
                // å…¨ã¦ã®ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º
                galleryItems.forEach((item) => {
                    item.classList.remove('hidden');
                });
                showMoreBtn.style.display = 'none'; // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            });
        }
    }

    // --- DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (åˆæœŸåŒ–å‡¦ç†ã®å®Ÿè¡Œ) ---
    document.addEventListener('DOMContentLoaded', () => {
        initializeStaticScripts(); // é™çš„è¦ç´ ã®åˆæœŸåŒ–
        loadReviews();             // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿é–‹å§‹
    });

    // --- ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ 'reviewPosted' ã®ãƒªã‚¹ãƒŠãƒ¼ (ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿å¾Œã®å‡¦ç†) ---
    document.addEventListener('reviewPosted', (event) => {
        console.log('æ–°è¦ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã‚’æ¤œçŸ¥:', event.detail);
        const newReviewData = event.detail; // ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const reviewsListContainer = document.getElementById('reviews-list');
        const noReviewsEl = document.getElementById('no-reviews-message');
        if (!reviewsListContainer) return; // ã‚³ãƒ³ãƒ†ãƒŠãŒãªã‘ã‚Œã°ä¸­æ–­

        // ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å‰Šé™¤
        if (noReviewsEl) {
            noReviewsEl.remove();
        }

        // æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨˜äº‹HTMLã‚’ç”Ÿæˆ
        const article = createReviewArticle(newReviewData);
        reviewsListContainer.prepend(article); // ãƒªã‚¹ãƒˆã®**å…ˆé ­**ã«è¿½åŠ 

        // ã‚‚ã—ç®¡ç†äººãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚¹ã‚³ã‚¢ãŒã‚ã‚Œã°ã€ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»
        if (newReviewData?.author === "é–¢ï¼ ã‚·ã‚¬ã‚´ãƒ«ç®¡ç†äºº" && newReviewData?.scores) {
             // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æç”»ã—ãªã„ã¨canvasè¦ç´ ã®æº–å‚™ãŒé–“ã«åˆã‚ãªã„å ´åˆãŒã‚ã‚‹
             setTimeout(renderRadarCharts, 100);
        }
    });

</script>

